---
interface Props {
  showSearch?: boolean
}

const { showSearch = false } = Astro.props

const navItems = [
  { href: '/', label: '首页', labelEn: 'Home' },
  { href: '/about', label: '关于', labelEn: 'About' },
  { href: '/products', label: '产品', labelEn: 'Products' },
  { href: '/blog', label: '博客', labelEn: 'Blog' },
  { href: '/gallery', label: '相册', labelEn: 'Gallery' },
  { href: '/links', label: '链接', labelEn: 'Links' },
]

const currentPath = Astro.url.pathname
---

<header class="sticky top-0 z-50 bg-white/80 dark:bg-gray-950/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-800">
  <div class="max-w-3xl mx-auto px-4 sm:px-6">
    <div class="flex items-center justify-between py-4">
      <a href="/" class="text-xl font-bold hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
        Tanglei
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center gap-4">
        {navItems.map((item) => (
          <a
            href={item.href}
            class:list={[
              'text-sm hover:text-blue-600 dark:hover:text-blue-400 transition-colors nav-item',
              currentPath === item.href || (item.href !== '/' && currentPath.startsWith(item.href))
                ? 'text-blue-600 dark:text-blue-400 font-medium'
                : 'text-gray-600 dark:text-gray-400'
            ]}
            data-label-zh={item.label}
            data-label-en={item.labelEn}
          >
            <span class="label-text">{item.label}</span>
          </a>
        ))}

        <!-- Language Toggle -->
        <button
          id="lang-toggle"
          class="px-3 py-1.5 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800 hover:border-blue-500 dark:hover:border-blue-400 transition-all text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400"
          aria-label="切换语言"
        >
          <span id="lang-text">EN</span>
        </button>

        <!-- Theme Toggle -->
        <button
          id="theme-toggle"
          class="relative w-14 h-7 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
          aria-label="切换主题"
        >
          <span class="absolute left-1 top-1 w-5 h-5 rounded-full bg-white dark:bg-gray-900 shadow-md transform dark:translate-x-7 transition-transform duration-300 flex items-center justify-center">
            <svg class="w-3 h-3 hidden dark:block text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg class="w-3 h-3 block dark:hidden text-gray-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          </span>
        </button>
      </nav>

      <!-- Mobile Menu Button -->
      <div class="flex items-center gap-2 md:hidden">
        <button
          id="lang-toggle-mobile"
          class="px-2.5 py-1 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-xs font-medium text-gray-600 dark:text-gray-400"
          aria-label="切换语言"
        >
          <span id="lang-text-mobile">EN</span>
        </button>
        <button
          id="theme-toggle-mobile"
          class="relative w-12 h-6 rounded-full bg-gray-200 dark:bg-gray-700 transition-all duration-300 focus:outline-none"
          aria-label="切换主题"
        >
          <span class="absolute left-0.5 top-0.5 w-5 h-5 rounded-full bg-white dark:bg-gray-900 shadow-md transform dark:translate-x-6 transition-transform duration-300 flex items-center justify-center">
            <svg class="w-3 h-3 hidden dark:block text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg class="w-3 h-3 block dark:hidden text-gray-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          </span>
        </button>
        <button
          id="mobile-menu-btn"
          class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
          aria-label="菜单"
        >
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <nav id="mobile-menu" class="hidden md:hidden pb-4">
      <div class="flex flex-col gap-2">
        {navItems.map((item) => (
          <a
            href={item.href}
            class:list={[
              'px-4 py-2 rounded-lg transition-colors nav-item',
              currentPath === item.href || (item.href !== '/' && currentPath.startsWith(item.href))
                ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 font-medium'
                : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800'
            ]}
            data-label-zh={item.label}
            data-label-en={item.labelEn}
          >
            <span class="label-text">{item.label}</span>
          </a>
        ))}
      </div>
    </nav>

    <!-- Search Box (only shown when showSearch is true) -->
    {showSearch && (
      <div class="pb-4">
        <div class="relative">
          <input
            type="text"
            id="blog-search"
            placeholder="搜索博客文章..."
            class="w-full px-4 py-2 pl-10 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
          />
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>
    )}
  </div>
</header>

<script>
  // Theme toggle
  const toggleTheme = () => {
    const html = document.documentElement
    html.classList.toggle('dark')
    localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light')
  }

  const theme = localStorage.getItem('theme') ||
    (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')

  if (theme === 'dark') {
    document.documentElement.classList.add('dark')
  }

  document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme)
  document.getElementById('theme-toggle-mobile')?.addEventListener('click', toggleTheme)

  // Language toggle
  const toggleLang = () => {
    const currentLang = localStorage.getItem('lang') || 'zh'
    const newLang = currentLang === 'zh' ? 'en' : 'zh'
    localStorage.setItem('lang', newLang)
    updateLanguage(newLang)
  }

  const updateLanguage = (lang: string) => {
    // Update toggle button text
    const langTexts = document.querySelectorAll('#lang-text, #lang-text-mobile')
    langTexts.forEach(el => {
      el.textContent = lang === 'zh' ? 'EN' : '中'
    })

    // Update nav items
    const navItems = document.querySelectorAll('.nav-item')
    navItems.forEach(item => {
      const labelText = item.querySelector('.label-text')
      if (labelText) {
        const zhLabel = item.getAttribute('data-label-zh')
        const enLabel = item.getAttribute('data-label-en')
        labelText.textContent = lang === 'zh' ? zhLabel : enLabel
      }
    })

    // Update search placeholder
    const searchInput = document.getElementById('blog-search') as HTMLInputElement
    if (searchInput) {
      searchInput.placeholder = lang === 'zh' ? '搜索博客文章...' : 'Search posts...'
    }

    // Update all translatable content on the page
    const translatables = document.querySelectorAll('[data-zh][data-en]')
    translatables.forEach(el => {
      const zhText = el.getAttribute('data-zh')
      const enText = el.getAttribute('data-en')
      if (zhText && enText) {
        el.textContent = lang === 'zh' ? zhText : enText
      }
    })

    // Update translatable placeholders
    const translatablePlaceholders = document.querySelectorAll('[data-placeholder-zh][data-placeholder-en]')
    translatablePlaceholders.forEach(el => {
      const zhText = el.getAttribute('data-placeholder-zh')
      const enText = el.getAttribute('data-placeholder-en')
      if (zhText && enText && el instanceof HTMLInputElement) {
        el.placeholder = lang === 'zh' ? zhText : enText
      }
    })

    // Set html lang attribute
    document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en'
  }

  // Initialize language
  const savedLang = localStorage.getItem('lang') || 'zh'
  updateLanguage(savedLang)

  document.getElementById('lang-toggle')?.addEventListener('click', toggleLang)
  document.getElementById('lang-toggle-mobile')?.addEventListener('click', toggleLang)

  // Mobile menu
  const menuBtn = document.getElementById('mobile-menu-btn')
  const mobileMenu = document.getElementById('mobile-menu')

  menuBtn?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden')
  })

  // Blog search functionality
  const searchInput = document.getElementById('blog-search') as HTMLInputElement
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase()
      const posts = document.querySelectorAll('[data-post-title]')

      posts.forEach(post => {
        const title = post.getAttribute('data-post-title')?.toLowerCase() || ''
        const description = post.getAttribute('data-post-description')?.toLowerCase() || ''

        if (title.includes(query) || description.includes(query)) {
          (post as HTMLElement).style.display = ''
        } else {
          (post as HTMLElement).style.display = 'none'
        }
      })
    })
  }
</script>
